!function(e){var t="kmseditors",n=function(){},o="undefined"==typeof console?{log:n,debug:n,error:n,warn:n,info:n}:console;if("undefined"!=typeof module&&module.exports||void 0===e[t]){var d="",a="",c={options:{},isInit:!1,$container:"",$position:""};c.init=function(n){if(n&&0!==Object.keys(n).length){if(!this.isInit){if(!n.container)return o.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+n.container),this.options=n,$(function(){c.$container.append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>锚点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>1、第一步：插入背景图</p><p>2、第二步：根据需求，添加文字 或者 锚点 或者边框</p><p>3、第三步：根据需求，可增加关联信息</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-color" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-edit" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group c4"></div></div></div></div>'),$("#kmseditors-contant").on("click",g);var t=$("#kmseditors-exitfullscreen");t.hide(),t.on("click",function(){g(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()});var i=$("#kmseditors-fullscreen");i.on("click",function(){var e;g(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()});var e=$("#kmseditors-sketch");e.on("click",function(e){r()});var n=$("#kmseditors-uploadimg");n.on("click",g),function(){if("undefined"!=typeof WebUploader){var e=c.options.uploadImgUrl;if(!e)return o.error("参数uploadImgUrl 未在init方法中传入");var t=c.options.fdModelId;if(!t)return o.error("参数fdModelId 未在init方法中传入");var i=e+="&fdModelId="+t,n=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});c.$container.find("#kmseditors-uploadimg").removeClass("webuploader-container"),c.$container.find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),n.on("fileQueued",function(e){}),n.on("beforeFileQueued",function(e){var t=c.$container.find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return n.cancelFile(e);t.remove()}),n.on("uploadProgress",function(e,t){var i=$("#"+e.id),n=i.find(".progress span");n.length||(n=$('<p class="progress"><span></span></p>').appendTo(i).find("span")),n.css("width",100*t+"%")}),n.on("uploadSuccess",function(e,t){var i=t._raw;if(!i)return o.error("_raw error",i);0!==c.$position.length&&c.$position.remove();var n=c.options.host+i;u(n)}),n.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")}),n.on("uploadComplete",function(e){$("#"+e.id).find(".progress").remove()})}}(),(d=$("#kmseditors-contextmenu")).hide(),c.options.editable&&(d.find("#kmseditors-contextmenu-relation").on("click",p),d.find("#kmseditors-contextmenu-color").on("click",m),d.find("#kmseditors-contextmenu-edit").on("click",f),d.find("#kmseditors-contextmenu-delete").on("click",l))}),setTimeout(function(){var e=n.data;if(e){var t=e.backgroundUrl,i=e.sketchList;t&&(g(),u(t),setTimeout(function(){var e=i.length;if(0<e)for(var t=0;t<e;t++){r(i[t])}},200),setTimeout(function(){var e=c.$container.width(),t=c.$container.find("img[ref=imageMaps]").width();e<t&&c.setZoom(e/t)},300))}n.editable||setTimeout(s,150)},100)}}else o.warn("请对"+t+".init()传入必要的参数")},c.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,n="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:n}}var n=c.$container.find("img[ref=imageMaps]");if(0<n.length&&(t.backgroundUrl=n.attr("src")),void 0!==e)return t.sketchList=i(e),t;var o=this.$position;if(!o)return t;var s=o.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],d=0;d<s.length;d++){var a=s[d];r.push(i($(a)))}return t.sketchList=r,t},c.setLinkStatus=function(e){var t=e.ref,i=e.isLink;if(!t||"boolean"!=typeof i)return o.error("setLinkStatus传入参数有误");var n=c.$container.find('div.map-position[dtype="0"][ref="'+t+'"]');0!==!n.length&&(i?n.addClass("isLink"):n.removeClass("isLink"))},c.setZoom=function(e){var t=e||1;c.$container.find("img[ref=imageMaps]").css({zoom:t}),c.$position.css({zoom:t})},"undefined"!=typeof module&&"object"==typeof exports?module.exports=c:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return c}):e[t]=c}else o.error(t+"已经存在啦啦啦啦~");function s(){c.$container.find("#kmseditors-title").hide(),setTimeout(function(){for(var e=c.$container.find('div.map-position[dtype="0"]'),t=c.options.onRelation||n,i=0;i<e.length;i++){$(e[i]).css({opacity:0,cursor:"pointer"}).on("click",function(){t(c.getData($(this)))})}},100)}function r(e){if(0===c.$container.find("img[ref=imageMaps]").length)return alert("请先上传背景图片");g();var t="10",i="10",n="90",o=c.$container.find('div.map-position[dtype="0"]').length+1,s=!1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(n=e.width),e.height&&(height=e.height),e.ref&&(o=e.ref),e.isLink&&(s=e.isLink));var u,r=s?" isLink":"";c.$position.append('<div ref="'+o+'" dtype="0" class="map-position'+r+'" style="top:'+t+"px;left:"+i+"px;width:"+n+'px;height:30px;"><div class="map-position-bg"></div><span class="resize"></span></div>'),c.options.editable&&(u=c.$position,c.$position.find(".map-position-bg").each(function(){var c=$(this);c.off("click").on("click",function(e){e.preventDefault(),(a=$(e.target).parent()).top=e.pageY,a.left=e.pageX,a.width=$(a).width(),a.height=$(a).height();var t=parseInt(a.attr("dtype")),i=$("#kmseditors-contextmenu-color"),n=$("#kmseditors-contextmenu-edit");0===t?(i.hide(),n.hide()):1===t&&(i.show(),n.show());var o=e.pageX,s=e.pageY,r=a[0];r&&(s=r.offsetTop+$(a).height(),o=r.offsetLeft+$(a).width()-d.width()),d.show().css({left:o,top:s})}).unbind("mousedown").mousedown(function(e){return d.hide(),c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),c.css("cursor","move"),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),c.css("cursor","default"),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var n=c.parent(),o=n.position(),s=o.left+t;s<0&&(s=0);var r=o.top+i;r<0&&(r=0);var d=r+n.height();d>u.height()&&(r-=d-u.height());var a=s+n.width();return a>u.width()&&(s-=a-u.width()),n.css({left:s,top:r}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),d=r+n.height(),a=s+n.width(),!1}).mouseup(function(e){return d.hide(),c.data("mousedown",!1),c.css("cursor","default"),!1})}),c.$position.find(".resize").each(function(){var c=$(this);c.unbind("mousedown").mousedown(function(e){return c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var n=c.parent(),o=n.position(),s=o.left,r=o.top,d=n.height()+i;r+d>u.height()&&(d-=r+d-u.height()),d<20&&(d=20);var a=n.width()+t;return s+a>u.width()&&(a-=s+a-u.width()),a<50&&(a=50),n.css({width:a,height:d}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),bottom=r+n.height(),right=s+n.width(),!1}).mouseup(function(e){return c.data("mousedown",!1),!1})}))}function u(e){if(e){var t='<img src="'+e+'" ref="imageMaps">';c.$container.find("#kmseditors-contant").append(t);var i=c.$container.find("img[ref=imageMaps]");i.after('<div class="position-conrainer"></div>'),setTimeout(function(){c.$position=c.$container.find(".position-conrainer");$("#kmseditors-contant"),$("#kmseditors-contant-tips");var e=i.width(),t=i.height();c.$position.css({top:0,left:0,width:e,height:t})},100)}}function p(){console.log("什么鬼"),d.hide(),(c.options.onRelation||n)(c.getData(a))}function l(){d.hide(),a.remove()}function f(){d.hide()}function m(){d.hide()}function g(){c.$container.find("#kmseditors-contant-tips").hide()}}(window);