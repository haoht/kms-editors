!function(e){var t="kmseditors",n=function(){},i="",s="undefined"==typeof console?{log:n,debug:n,error:n,warn:n,info:n}:console;if("undefined"!=typeof module&&module.exports||void 0===e[t]){var p="",l="",c={options:{},isInit:!1,$container:"",$position:""};c.init=function(o){if(o&&0!==Object.keys(o).length){if(!this.isInit){if(!o.container)return s.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+o.container),this.options=o,$(function(){c.$container.append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>锚点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>1、第一步：插入背景图</p><p>2、第二步：根据需求，添加文字 或者 锚点 或者边框</p><p>3、第三步：根据需求，可增加关联信息</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-color" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-edit" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group c4"></div></div></div><div id="kmseditors-sidebar"></div></div>'),function(){if(!c.options.editable){var e=$("#kmseditors-sidebar");e.append('<ul><li class="lui_icon_s lui_icon_s_icon_repeat mui mui-history_handler_back" title="还原" data-opt="zoomReset"></li><li class="lui_icon_s lui_icon_s_icon_zoom_in mui mui-addition" title="放大" data-opt="zoomIn"></li><li class="lui_icon_s lui_icon_s_icon_zoom_out mui mui-delete" title="缩小" data-opt="zoomOut"></li></ul>'),e.on("click",function(e){var t=$(e.target),i=t.attr("data-opt");i&&c[i]&&c[i]()})}}(),c.options.editable||c.$container.css({"text-align":"center"}),$("#kmseditors-contant").on("click",h);var t=$("#kmseditors-exitfullscreen");t.hide(),t.on("click",function(){h(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()});var i=$("#kmseditors-fullscreen");i.on("click",function(){var e;h(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()});var e=$("#kmseditors-sketch");e.on("click",function(e){d()});var o=$("#kmseditors-uploadimg");o.on("click",h),function(){if("undefined"!=typeof WebUploader){var e=c.options.uploadImgUrl;if(!e)return s.error("参数uploadImgUrl 未在init方法中传入");var t=c.options.fdModelId;if(!t)return s.error("参数fdModelId 未在init方法中传入");var i=e+="&fdModelId="+t,o=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});c.$container.find("#kmseditors-uploadimg").removeClass("webuploader-container"),c.$container.find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),o.on("fileQueued",function(e){}),o.on("beforeFileQueued",function(e){var t=c.$container.find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return o.cancelFile(e);t.remove()}),o.on("uploadProgress",function(e,t){var i=$("#"+e.id),o=i.find(".progress span");o.length||(o=$('<p class="progress"><span></span></p>').appendTo(i).find("span")),o.css("width",100*t+"%")}),o.on("uploadSuccess",function(e,t){var i=t._raw;if(!i)return s.error("_raw error",i);0!==c.$position.length&&c.$position.remove();var o=c.options.host+i;a(o)}),o.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")}),o.on("uploadComplete",function(e){$("#"+e.id).find(".progress").remove()})}}(),(p=$("#kmseditors-contextmenu")).hide(),c.options.editable&&(p.find("#kmseditors-contextmenu-relation").on("click",u),p.find("#kmseditors-contextmenu-color").on("click",g),p.find("#kmseditors-contextmenu-edit").on("click",f),p.find("#kmseditors-contextmenu-delete").on("click",m))}),setTimeout(function(){var e=o.data;if(e){var t=e.backgroundUrl,i=e.sketchList;t&&(h(),a(t),setTimeout(function(){var e=i.length;if(0<e)for(var t=0;t<e;t++){d(i[t])}},200),setTimeout(function(){var e=c.$container.width(),t=c.$container.find("img[ref=imageMaps]").width(),i=1;e<t&&(i=e/t),c.setZoom(i)},300))}o.editable||setTimeout(r,150)},100)}}else s.warn("请对"+t+".init()传入必要的参数")},c.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,o="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:o}}var o=c.$container.find("img[ref=imageMaps]");if(0<o.length&&(t.backgroundUrl=o.attr("src")),void 0!==e)return t.sketchList=i(e),t;var n=this.$position;if(!n)return t;var s=n.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],d=0;d<s.length;d++){var a=s[d];r.push(i($(a)))}return t.sketchList=r,t},c.setLinkStatus=function(e){var t=e.ref,i=e.isLink;if(!t||"boolean"!=typeof i)return s.error("setLinkStatus传入参数有误");var o=c.$container.find('div.map-position[dtype="0"][ref="'+t+'"]');0!==!o.length&&(i?o.addClass("isLink"):o.removeClass("isLink"))},c.setZoom=function(e){var t=e||1;""===i&&(i=t),c.$container.find("#kmseditors-contant-sketch-warp").css({zoom:t})},c.getZoom=function(){return{initZoom:i,currZoom:parseFloat(c.$container.find("#kmseditors-contant-sketch-warp").css("zoom"))}},c.zoomIn=function(){var e=c.getZoom().currZoom+.1,t=2*i;t<=e&&(e=t),c.setZoom(e)},c.zoomOut=function(){var e=c.getZoom().currZoom-.1,t=.6*i;e<=t&&(e=t),c.setZoom(e)},c.zoomReset=function(){c.setZoom(i)},"undefined"!=typeof module&&"object"==typeof exports?module.exports=c:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return c}):e[t]=c}else s.error(t+"已经存在啦啦啦啦~");function r(){c.$container.find("#kmseditors-title").hide(),setTimeout(function(){for(var e=c.$container.find('div.map-position[dtype="0"]'),t=c.options.onRelation||n,i=c.options.debug?1:0,o=0;o<e.length;o++){$(e[o]).css({opacity:i,cursor:"pointer"}).on("click",function(){t(c.getData($(this)))})}},100)}function d(e){if(0!==c.$container.find("img[ref=imageMaps]").length){h();var t="10",i="10",o="160",n="160",s=c.$container.find('div.map-position[dtype="0"]').length+1,r=!1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(o=e.width),e.height&&(n=e.height),e.ref&&(s=e.ref),e.isLink&&(r=e.isLink));var u,d=r?" isLink":"";c.$position.append('<div ref="'+s+'" dtype="0" class="map-position'+d+'" style="top:'+t+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg"></div><span class="resize"></span></div>'),c.options.editable&&(u=c.$position,c.$position.find(".map-position-bg").each(function(){var c=$(this);c.off("click").on("click",function(e){e.preventDefault(),(l=$(e.target).parent()).top=e.pageY,l.left=e.pageX,l.width=$(l).width(),l.height=$(l).height();var t=parseInt(l.attr("dtype")),i=$("#kmseditors-contextmenu-color"),o=$("#kmseditors-contextmenu-edit");0===t?(i.hide(),o.hide()):1===t&&(i.show(),o.show());var n=e.pageX,s=e.pageY,r=l[0];r&&(s=r.offsetTop+$(l).height(),n=r.offsetLeft+$(l).width()-p.width()),p.show().css({left:n,top:s})}).unbind("mousedown").mousedown(function(e){return p.hide(),c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),c.css("cursor","move"),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),c.css("cursor","default"),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var o=c.parent(),n=o.position(),s=n.left+t;s<0&&(s=0);var r=n.top+i;r<0&&(r=0);var d=r+o.height();d>u.height()&&(r-=d-u.height());var a=s+o.width();return a>u.width()&&(s-=a-u.width()),o.css({left:s,top:r}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),d=r+o.height(),a=s+o.width(),!1}).mouseup(function(e){return p.hide(),c.data("mousedown",!1),c.css("cursor","default"),!1})}),c.$position.find(".resize").each(function(){var c=$(this);c.unbind("mousedown").mousedown(function(e){return c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var o=c.parent(),n=o.position(),s=n.left,r=n.top,d=o.height()+i;r+d>u.height()&&(d-=r+d-u.height()),d<20&&(d=20);var a=o.width()+t;return s+a>u.width()&&(a-=s+a-u.width()),a<50&&(a=50),o.css({width:a,height:d}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),bottom=r+o.height(),right=s+o.width(),!1}).mouseup(function(e){return c.data("mousedown",!1),!1})}))}else{var a="请先上传图片！";window.seajs?seajs.use("lui/dialog",function(e){e.alert(a)}):alert(a)}}function a(e){if(e){var t='<div id="kmseditors-contant-sketch-warp"><img src="'+e+'" ref="imageMaps"><div class="position-conrainer"></div></div>';c.$container.find("#kmseditors-contant").append(t);var i=c.$container.find("img[ref=imageMaps]");setTimeout(function(){c.$position=c.$container.find(".position-conrainer");$("#kmseditors-contant"),$("#kmseditors-contant-tips");var e=i.width(),t=i.height();c.$position.css({top:0,left:0,width:e,height:t})},100)}}function u(){p.hide(),(c.options.onRelation||n)(c.getData(l))}function m(){p.hide(),l.remove()}function f(){p.hide()}function g(){p.hide()}function h(){c.$container.find("#kmseditors-contant-tips").hide()}}(window);