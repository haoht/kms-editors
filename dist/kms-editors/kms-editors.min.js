!function(e){var t="kmseditors",c=function(){},a="",s="undefined"==typeof console?{log:c,debug:c,error:c,warn:c,info:c}:console;if("undefined"!=typeof module&&module.exports||void 0===e[t]){var l="",p="",m={options:{},isInit:!1,$container:"",$position:""};m.init=function(a){if(a&&0!==Object.keys(a).length){if(!this.isInit){if(!a.container)return s.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+a.container),this.options=a,$(function(){m.$container.append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>锚点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>1、第一步：插入背景图</p><p>2、第二步：根据需求，添加文字 或者 锚点 或者边框</p><p>3、第三步：根据需求，可增加关联信息</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-color" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-edit" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group c4"></div></div></div></div>'),function(){if(!m.options.editable){var e=$('<div id="kmseditors-sidebar"></div>');m.$container.append(e),m.$container.css("position","relative"),e.append('<ul><li class="lui_icon_s lui_icon_s_icon_repeat mui mui-history_handler_back" title="还原" data-opt="zoomReset"></li><li class="lui_icon_s lui_icon_s_icon_zoom_in mui mui-addition" title="放大" data-opt="zoomIn"></li><li class="lui_icon_s lui_icon_s_icon_zoom_out mui mui-delete" title="缩小" data-opt="zoomOut"></li></ul>'),e.on("click",function(e){var t=$(e.target),i=t.attr("data-opt");i&&m[i]&&m[i]()})}}(),m.options.editable||m.$container.css({"text-align":"center"}),$("#kmseditors-contant").on("click",g);var t=$("#kmseditors-exitfullscreen");t.hide(),t.on("click",function(){g(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()});var i=$("#kmseditors-fullscreen");i.on("click",function(){var e;g(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()});var e=$("#kmseditors-sketch");e.on("click",function(e){u()});var o=$("#kmseditors-uploadimg");o.on("click",g),function(){if("undefined"!=typeof WebUploader){var e=m.options.uploadImgUrl;if(!e)return s.error("参数uploadImgUrl 未在init方法中传入");var t=m.options.fdModelId;if(!t)return s.error("参数fdModelId 未在init方法中传入");var i=e+="&fdModelId="+t,o=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});m.$container.find("#kmseditors-uploadimg").removeClass("webuploader-container"),m.$container.find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),o.on("beforeFileQueued",function(e){var t=m.$container.find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return o.cancelFile(e);t.remove()}),o.on("uploadSuccess",function(e,t){var i=t._raw;if(!i)return s.error("_raw error",i);var o=m.$container.find("#kmseditors-contant-sketch-warp");o&&0<o.length&&o.remove();var n=m.options.host+i;f(n)}),o.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")})}}(),(l=$("#kmseditors-contextmenu")).hide(),m.options.editable&&(l.find("#kmseditors-contextmenu-relation").on("click",n),l.find("#kmseditors-contextmenu-color").on("click",h),l.find("#kmseditors-contextmenu-edit").on("click",v),l.find("#kmseditors-contextmenu-delete").on("click",r))});var d=setInterval(function(){if(0!==m.$container.find(".kmseditors").length){clearInterval(d);var e=a.data;if(e){var t=e.backgroundUrl,i=e.sketchList;if(t){g(),f(t);var o=setInterval(function(){if(0!==m.$position.length){clearInterval(o);var e=i.length;if(0<e)for(var t=0;t<e;t++){u(i[t])}}},10),n=0,s=0,r=setInterval(function(){if(0<n&&0<s){clearInterval(r);var e=1;n<s&&(e=n/s),m.setZoom(e)}else n=m.$container.width(),s=m.$container.find("img[ref=imageMaps]").width()},10)}}a.editable||function(){m.$container.find("#kmseditors-title").hide();var s=setInterval(function(){if(0!==m.$position.length){clearInterval(s);var e=m.$container.find('div.map-position[dtype="0"]'),t=m.options.onRelation||c,i=!0===m.options.debug?1:0;if(e)for(var o=0;o<e.length;o++){var n=$(e[o]);n.css({opacity:i,cursor:"pointer"}).on("click",function(){t(m.getData($(this)))})}}},10)}()}},10)}}else s.warn("请对"+t+".init()传入必要的参数")},m.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,o="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:o}}var o=m.$container.find("img[ref=imageMaps]");if(0<o.length&&(t.backgroundUrl=o.attr("src")),void 0!==e)return t.sketchList=i(e),t;var n=this.$position;if(!n)return t;var s=n.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],a=0;a<s.length;a++){var d=s[a];r.push(i($(d)))}return t.sketchList=r,t},m.setLinkStatus=function(e){var t=e.ref,i=e.isLink;if(!t||"boolean"!=typeof i)return s.error("setLinkStatus传入参数有误");var o=m.$container.find('div.map-position[dtype="0"][ref="'+t+'"]');0!==!o.length&&(i?o.addClass("isLink"):o.removeClass("isLink"))},m.setZoom=function(e){var t=e||1;""===a&&(a=t),m.$container.find("#kmseditors-contant-sketch-warp").css({zoom:t,"-moz-transform":"scale("+t+")"})},m.getZoom=function(){var e=m.$container.find("#kmseditors-contant-sketch-warp"),t=e.css("zoom");if(!t){var i=e.attr("style");if(i)for(var o=i.split(";"),n=0;n<o.length;n++){var s=o[n],r=s.indexOf("scale");if(-1===r)break;t=s.substring(r+6,s.length-1);break}}return{initZoom:a,currZoom:parseFloat(t)}},m.zoomIn=function(){var e=m.getZoom().currZoom+.1,t=2*a;t<=e&&(e=t),m.setZoom(e)},m.zoomOut=function(){var e=m.getZoom().currZoom-.1,t=.6*a;e<=t&&(e=t),m.setZoom(e)},m.zoomReset=function(){m.setZoom(a)},"undefined"!=typeof module&&"object"==typeof exports?module.exports=m:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return m}):e[t]=m}else s.error(t+"已经存在啦啦啦啦~");function u(e){if(0!==m.$container.find("img[ref=imageMaps]").length){g();var t="10",i="10",o="90",n="30",s=m.$container.find('div.map-position[dtype="0"]').length+1,r=!1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(o=e.width),e.height&&(n=e.height),e.ref&&(s=e.ref),e.isLink&&(r=e.isLink));var u,a=r?" isLink":"";m.$position.append('<div ref="'+s+'" dtype="0" class="map-position'+a+'" style="top:'+t+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg"></div><span class="resize"></span></div>'),m.options.editable&&(u=m.$position,m.$position.find(".map-position-bg").each(function(){var c=$(this);c.off("click").on("click",function(e){e.preventDefault(),(p=$(e.target).parent()).top=e.pageY,p.left=e.pageX,p.width=$(p).width(),p.height=$(p).height();var t=parseInt(p.attr("dtype")),i=$("#kmseditors-contextmenu-color"),o=$("#kmseditors-contextmenu-edit");0===t?(i.hide(),o.hide()):1===t&&(i.show(),o.show());var n=e.pageX,s=e.pageY,r=p[0];r&&(s=r.offsetTop+$(p).height(),n=r.offsetLeft+$(p).width()-l.width()),l.show().css({left:n,top:s})}).unbind("mousedown").mousedown(function(e){return l.hide(),c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),c.css("cursor","move"),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),c.css("cursor","default"),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var o=c.parent(),n=o.position(),s=n.left+t;s<0&&(s=0);var r=n.top+i;r<0&&(r=0);var a=r+o.height();a>u.height()&&(r-=a-u.height());var d=s+o.width();return d>u.width()&&(s-=d-u.width()),o.css({left:s,top:r}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),a=r+o.height(),d=s+o.width(),!1}).mouseup(function(e){return l.hide(),c.data("mousedown",!1),c.css("cursor","default"),!1})}),m.$position.find(".resize").each(function(){var c=$(this);c.unbind("mousedown").mousedown(function(e){return l.hide(),c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var o=c.parent(),n=o.position(),s=n.left,r=n.top,a=o.height()+i;r+a>u.height()&&(a-=r+a-u.height()),a<20&&(a=20);var d=o.width()+t;return s+d>u.width()&&(d-=s+d-u.width()),d<50&&(d=50),o.css({width:d,height:a}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),bottom=r+o.height(),right=s+o.width(),!1}).mouseup(function(e){return c.data("mousedown",!1),!1})}))}else{var d="请先上传图片！";window.seajs?seajs.use("lui/dialog",function(e){e.alert(d)}):alert(d)}}function f(e){if(e){var t='<div id="kmseditors-contant-sketch-warp"><img src="'+e+'" ref="imageMaps"><div class="position-conrainer"></div></div>';m.$container.find("#kmseditors-contant").append(t);var i=m.$container.find("img[ref=imageMaps]"),o=0,n=0,s=setInterval(function(){if(0<o&&0<n){clearInterval(s),m.$position=m.$container.find(".position-conrainer");$("#kmseditors-contant"),$("#kmseditors-contant-tips");m.$position.css({top:0,left:0,width:o,height:n})}else o=i.width(),n=i.height()},10)}}function n(){l.hide(),(m.options.onRelation||c)(m.getData(p))}function r(){l.hide(),p.remove()}function v(){l.hide()}function h(){l.hide()}function g(){m.$container.find("#kmseditors-contant-tips").hide()}}(window);