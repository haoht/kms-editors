!function(e){var t="kmseditors",d=function(){},o="undefined"==typeof console?{log:d,debug:d,error:d,warn:d,info:d}:console;if("undefined"!=typeof module&&module.exports||void 0===e[t]){var a="",p="",u={options:{},isInit:!1,$container:"",$position:""};u.init=function(n){if(n&&0!==Object.keys(n).length){if(!this.isInit){if(!n.container)return o.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+n.container),this.options=n,$(function(){u.$container.append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>锚点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>1、第一步：插入背景图</p><p>2、第二步：根据需求，添加文字 或者 锚点 或者边框</p><p>3、第三步：根据需求，可增加关联信息</p></div></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group c4"></div></div></div>'),$("#kmseditors-contant").on("click",g);var t=$("#kmseditors-exitfullscreen");t.hide(),t.on("click",function(){g(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()});var i=$("#kmseditors-fullscreen");i.on("click",function(){var e;g(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()});var e=$("#kmseditors-sketch");e.on("click",function(e){r()});var n=$("#kmseditors-uploadimg");n.on("click",g),function(){if("undefined"!=typeof WebUploader){var e=u.options.uploadImgUrl;if(!e)return o.error("参数uploadImgUrl 未在init方法中传入");var t=u.options.fdModelId;if(!t)return o.error("参数fdModelId 未在init方法中传入");var i=e+="&fdModelId="+t,n=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});n.on("fileQueued",function(e){}),n.on("beforeFileQueued",function(e){var t=u.$container.find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return n.cancelFile(e);t.remove()}),n.on("uploadProgress",function(e,t){var i=$("#"+e.id),n=i.find(".progress span");n.length||(n=$('<p class="progress"><span></span></p>').appendTo(i).find("span")),n.css("width",100*t+"%")}),n.on("uploadSuccess",function(e,t){var i=t._raw;if(!i)return o.error("_raw error",i);0!==u.$position.length&&u.$position.remove();var n=u.options.host+i;c(n)}),n.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")}),n.on("uploadComplete",function(e){$("#"+e.id).find(".progress").remove()})}}(),(a=$("#kmseditors-contextmenu")).hide(),u.options.editable&&(a.find("#kmseditors-contextmenu-relation").on("click",f),a.find("#kmseditors-contextmenu-color").on("click",h),a.find("#kmseditors-contextmenu-edit").on("click",m),a.find("#kmseditors-contextmenu-delete").on("click",l))}),setTimeout(function(){var e=n.data;if(e){var t=e.backgroundUrl,i=e.sketchList;t&&(g(),c(t),setTimeout(function(){var e=i.length;if(0<e)for(var t=0;t<e;t++){r(i[t])}},200))}n.editable||setTimeout(s,150)},100)}}else o.warn("请对"+t+".init()传入必要的参数")},u.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,n="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:n}}var n=u.$container.find("img[ref=imageMaps]");if(0<n.length&&(t.backgroundUrl=n.attr("src")),void 0!==e)return t.sketchList=i(e),t;var o=this.$position;if(!o)return t;var s=o.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],d=0;d<s.length;d++){var a=s[d];r.push(i($(a)))}return t.sketchList=r,t},u.setLinkStatus=function(e){var t=e.ref,i=e.isLink;if(!t||"boolean"!=typeof i)return o.error("setLinkStatus传入参数有误");var n=u.$container.find('div.map-position[dtype="0"][ref="'+t+'"]');0!==!n.length&&(i?n.addClass("isLink"):n.removeClass("isLink"))},"undefined"!=typeof module&&"object"==typeof exports?module.exports=u:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return u}):e[t]=u}else o.error(t+"已经存在啦啦啦啦~");function s(){u.$container.find("#kmseditors-title").hide(),setTimeout(function(){for(var e=u.$container.find('div.map-position[dtype="0"]'),t=u.options.onRelation||d,i=0;i<e.length;i++){$(e[i]).css({opacity:0,cursor:"pointer"}).on("click",function(){t(u.getData($(this)))})}},100)}function r(e){if(0===u.$container.find("img[ref=imageMaps]").length)return alert("请先上传背景图片");g();var t="10",i="10",n="90",o=u.$container.find('div.map-position[dtype="0"]').length+1,s=!1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(n=e.width),e.height&&(height=e.height),e.ref&&(o=e.ref),e.isLink&&(s=e.isLink));var c,r=s?" isLink":"";u.$position.append('<div ref="'+o+'" dtype="0" class="map-position'+r+'" style="top:'+t+"px;left:"+i+"px;width:"+n+'px;height:30px;"><div class="map-position-bg"></div><span class="resize"></span></div>'),u.options.editable&&(c=u.$position,u.$position.find(".map-position-bg").each(function(){var u=$(this),o=!1;u.off("contextmenu",d).on("contextmenu",function(e){o=!0,(p=$(e.target).parent()).top=e.pageY,p.left=e.pageX,p.width=$(p).width(),p.height=$(p).height(),e.preventDefault();var t=parseInt(p.attr("dtype")),i=$("#kmseditors-contextmenu-color"),n=$("#kmseditors-contextmenu-edit");0===t?(i.hide(),n.hide()):1===t&&(i.show(),n.show()),a.show().css({left:e.pageX,top:e.pageY}),u.data("mousedown",!1),u.css("cursor","default"),setTimeout(function(){o=!1},100)}),u.unbind("mousedown").mousedown(function(e){return setTimeout(function(){return o||(a.hide(),u.data("mousedown",!0),u.data("pageX",e.pageX),u.data("pageY",e.pageY),u.css("cursor","move")),!1},50)}).unbind("mouseup").mouseup(function(e){return u.data("mousedown",!1),u.css("cursor","default"),!1}),c.mousemove(function(e){if(!u.data("mousedown"))return!1;var t=e.pageX-u.data("pageX"),i=e.pageY-u.data("pageY");if(0==t&&0==i)return!1;var n=u.parent(),o=n.position(),s=o.left+t;s<0&&(s=0);var r=o.top+i;r<0&&(r=0);var d=r+n.height();d>c.height()&&(r-=d-c.height());var a=s+n.width();return a>c.width()&&(s-=a-c.width()),n.css({left:s,top:r}),u.data("pageX",e.pageX),u.data("pageY",e.pageY),d=r+n.height(),a=s+n.width(),!1}).mouseup(function(e){return a.hide(),u.data("mousedown",!1),u.css("cursor","default"),!1})}),u.$position.find(".resize").each(function(){var u=$(this);u.unbind("mousedown").mousedown(function(e){return u.data("mousedown",!0),u.data("pageX",e.pageX),u.data("pageY",e.pageY),!1}).unbind("mouseup").mouseup(function(e){return u.data("mousedown",!1),!1}),c.mousemove(function(e){if(!u.data("mousedown"))return!1;var t=e.pageX-u.data("pageX"),i=e.pageY-u.data("pageY");if(0==t&&0==i)return!1;var n=u.parent(),o=n.position(),s=o.left,r=o.top,d=n.height()+i;r+d>c.height()&&(d-=r+d-c.height()),d<20&&(d=20);var a=n.width()+t;return s+a>c.width()&&(a-=s+a-c.width()),a<50&&(a=50),n.css({width:a,height:d}),u.data("pageX",e.pageX),u.data("pageY",e.pageY),bottom=r+n.height(),right=s+n.width(),!1}).mouseup(function(e){return u.data("mousedown",!1),!1})}))}function c(e){if(e){var t='<img src="'+e+'" ref="imageMaps">';u.$container.find("#kmseditors-contant").append(t);var r=u.$container.find("img[ref=imageMaps]");r.after('<div class="position-conrainer"></div>'),setTimeout(function(){u.$position=u.$container.find(".position-conrainer");var e=$("#kmseditors-contant"),t=$("#kmseditors-contant-tips"),i=e.offset().top-t.height()-5,n=u.$position.offset().left,o=r.width(),s=r.height();u.$position.css({top:i,left:n,width:o,height:s})},100)}}function f(){a.hide(),(u.options.onRelation||d)(u.getData(p))}function l(){a.hide(),p.remove()}function m(){a.hide()}function h(){a.hide()}function g(){u.$container.find("#kmseditors-contant-tips").hide()}}(window);