!function(e){var t="kmseditors",s=function(){},i="undefined"==typeof console?{log:s,debug:s,error:s,warn:s,info:s}:console;if("undefined"!=typeof module&&module.exports||void 0===e[t]){var r="",a="",c={options:{},isInit:!1,$container:"",$position:""};c.init=function(n){if(n&&0!==Object.keys(n).length){if(!this.isInit){if(!n.container)return i.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+n.container),this.options=n,$(function(){c.$container.append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><img src="./src/images/btn1.png" alt=""><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><img src="./src/images/btn5.png" alt=""><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><img src="./src/images/btn2.png" alt=""><p>锚点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><img src="./src/images/btn4.png" alt=""><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>1、第一步：插入背景图</p><p>2、第二步：根据需求，添加文字 或者 锚点 或者边框</p><p>3、第三步：根据需求，可增加关联信息</p></div></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group"><img src="./src/images/c1.png" alt=""></div><div id="kmseditors-contextmenu-color" class="kmseditors-contextmenu-group"><img src="./src/images/c2.png" alt=""></div><div id="kmseditors-contextmenu-edit" class="kmseditors-contextmenu-group"><img src="./src/images/c3.png" alt=""></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group"><img src="./src/images/c4.png" alt=""></div></div></div>'),$("#kmseditors-contant").on("click",g);var t=$("#kmseditors-exitfullscreen");t.hide(),t.on("click",function(){g(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()});var i=$("#kmseditors-fullscreen");i.on("click",function(){var e;g(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()});var e=$("#kmseditors-sketch");e.on("click",function(e){d()});var n=$("#kmseditors-uploadimg");n.on("click",g),function(){if("undefined"!=typeof WebUploader){var e=c.options.uploadImgUrl+="&fdModelId="+function(){for(var e=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],t="",i=0;i<32;i++){var n=parseInt(61*Math.random());t+=e[n]}return t}(),i=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:e,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});i.on("fileQueued",function(e){}),i.on("beforeFileQueued",function(e){var t=c.$container.find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return i.cancelFile(e);t.remove()}),i.on("uploadProgress",function(e,t){var i=$("#"+e.id),n=i.find(".progress span");n.length||(n=$('<p class="progress"><span></span></p>').appendTo(i).find("span")),n.css("width",100*t+"%")}),i.on("uploadSuccess",function(e,t){var i=t._raw;if(!i)return console.log("_raw error",i);var n=c.$container.find('div.map-position[dtype="0"]');0<n.length&&n.remove();var o=c.options.host+i;u(o)}),i.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")}),i.on("uploadComplete",function(e){$("#"+e.id).find(".progress").remove()})}}(),(r=$("#kmseditors-contextmenu")).hide(),c.options.editable&&(r.find("#kmseditors-contextmenu-relation").on("click",p),r.find("#kmseditors-contextmenu-color").on("click",f),r.find("#kmseditors-contextmenu-edit").on("click",l),r.find("#kmseditors-contextmenu-delete").on("click",m))}),setTimeout(function(){var e=n.data;if(e){var t=e.backgroundUrl,i=e.sketchList;t&&(g(),u(t),setTimeout(function(){var e=i.length;if(0<e)for(var t=0;t<e;t++){d(i[t])}},200))}n.editable||setTimeout(o,150)},100)}}else i.warn("请对"+t+".init()传入必要的参数")},c.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,n="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:n}}var n=c.$container.find("img[ref=imageMaps]");if(0<n.length&&(t.backgroundUrl=n.attr("src")),void 0!==e)return t.sketchList=i(e),t;var o=this.$position;if(!o)return t;var s=o.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],a=0;a<s.length;a++){var d=s[a];r.push(i($(d)))}return t.sketchList=r,t},"undefined"!=typeof module&&"object"==typeof exports?module.exports=c:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return c}):e[t]=c}else i.log(t+"已经存在啦啦啦啦~");function o(){c.$container.find("#kmseditors-title").hide(),setTimeout(function(){for(var e=c.$container.find('div.map-position[dtype="0"]'),t=c.options.onRelation||s,i=0;i<e.length;i++){$(e[i]).css({opacity:0,cursor:"pointer"}).on("click",function(){t(c.getData($(this)))})}},100)}function d(e){if(0===c.$container.find("img[ref=imageMaps]").length)return alert("请先上传背景图片");g();var u,t="10",i="10",n="90",o=c.$container.find('div.map-position[dtype="0"]').length+1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(n=e.width),e.height&&(height=e.height),e.ref&&(o=e.ref)),c.$position.append('<div ref="'+o+'" dtype="0" class="map-position" style="top:'+t+"px;left:"+i+"px;width:"+n+'px;height:30px;"><div class="map-position-bg"></div><span class="link-number-text">Link '+o+'</span><span class="resize"></span></div>'),c.options.editable&&(u=c.$position,c.$position.find(".map-position-bg").each(function(){var c=$(this),o=!1;c.off("contextmenu",s).on("contextmenu",function(e){o=!0,(a=$(e.target).parent()).top=e.pageY,a.left=e.pageX,a.width=$(a).width(),a.height=$(a).height(),e.preventDefault();var t=parseInt(a.attr("dtype")),i=$("#kmseditors-contextmenu-color"),n=$("#kmseditors-contextmenu-edit");0===t?(i.hide(),n.hide()):1===t&&(i.show(),n.show()),r.show().css({left:e.pageX,top:e.pageY}),c.data("mousedown",!1),c.css("cursor","default"),setTimeout(function(){o=!1},100)}),c.unbind("mousedown").mousedown(function(e){return setTimeout(function(){return o||(r.hide(),c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),c.css("cursor","move")),!1},50)}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),c.css("cursor","default"),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var n=c.parent(),o=n.position(),s=o.left+t;s<0&&(s=0);var r=o.top+i;r<0&&(r=0);var a=r+n.height();a>u.height()&&(r-=a-u.height());var d=s+n.width();return d>u.width()&&(s-=d-u.width()),n.css({left:s,top:r}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),a=r+n.height(),d=s+n.width(),!1}).mouseup(function(e){return r.hide(),c.data("mousedown",!1),c.css("cursor","default"),!1})}),c.$position.find(".resize").each(function(){var c=$(this);c.unbind("mousedown").mousedown(function(e){return c.data("mousedown",!0),c.data("pageX",e.pageX),c.data("pageY",e.pageY),!1}).unbind("mouseup").mouseup(function(e){return c.data("mousedown",!1),!1}),u.mousemove(function(e){if(!c.data("mousedown"))return!1;var t=e.pageX-c.data("pageX"),i=e.pageY-c.data("pageY");if(0==t&&0==i)return!1;var n=c.parent(),o=n.position(),s=o.left,r=o.top,a=n.height()+i;r+a>u.height()&&(a-=r+a-u.height()),a<20&&(a=20);var d=n.width()+t;return s+d>u.width()&&(d-=s+d-u.width()),d<50&&(d=50),n.css({width:d,height:a}),c.data("pageX",e.pageX),c.data("pageY",e.pageY),bottom=r+n.height(),right=s+n.width(),!1}).mouseup(function(e){return c.data("mousedown",!1),!1})}))}function u(e){if(e){var t='<img src="'+e+'" ref="imageMaps">';c.$container.find("#kmseditors-contant").append(t);var r=c.$container.find("img[ref=imageMaps]");r.after('<div class="position-conrainer"></div>'),setTimeout(function(){c.$position=c.$container.find(".position-conrainer");var e=$("#kmseditors-contant"),t=$("#kmseditors-contant-tips"),i=e.offset().top-t.height()-5,n=c.$position.offset().left,o=r.width(),s=r.height();c.$position.css({top:i,left:n,width:o,height:s})},100)}}function p(){r.hide(),(c.options.onRelation||s)(c.getData(a))}function m(){r.hide(),a.remove()}function l(){r.hide()}function f(){r.hide()}function g(){c.$container.find("#kmseditors-contant-tips").hide()}}(window);